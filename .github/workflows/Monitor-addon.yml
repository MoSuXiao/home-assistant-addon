name: Monitor Addon Release

on:
  # schedule:
    # - cron: '0 17 * * *'
  # æ‰‹åŠ¨è§¦å‘ï¼ˆæ–¹ä¾¿æµ‹è¯•ï¼‰
  workflow_dispatch:
    inputs:
      repositories:
        description: 'Repositories to monitor (comma-separated, e.g. owner1/repo1,owner2/repo2)'
        required: false
        default: 'esphome/home-assistant-addon'

jobs:
  # å®šä¹‰è¦ç›‘æ§çš„ä»“åº“çŸ©é˜µ
  setup-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set matrix from inputs or default
        id: set-matrix
        run: |
          # ä»è¾“å…¥å‚æ•°æˆ–é»˜è®¤å€¼è·å–ä»“åº“åˆ—è¡¨
          repositories="${{ github.event.inputs.repositories || 'esphome/home-assistant-addon' }}"
          
          # åˆå§‹åŒ– JSON æ•°ç»„
          json_array="["
          first=true
          
          # å¤„ç†æ¯ä¸ªä»“åº“
          IFS=',' read -ra repo_array <<< "$repositories"
          for repo in "${repo_array[@]}"; do
            # åˆ†å‰² owner å’Œ repo
            owner=$(echo "$repo" | cut -d'/' -f1)
            repo_name=$(echo "$repo" | cut -d'/' -f2)
          
            # è·³è¿‡ç©ºå€¼
            if [ -z "$owner" ] || [ -z "$repo_name" ]; then
              continue
            fi
          
            # æ·»åŠ åˆ° JSON æ•°ç»„
            if [ "$first" = true ]; then
              first=false
            else
              json_array+=","
            fi
          
            json_array+="{\"owner\":\"$owner\",\"repo\":\"$repo_name\"}"
          done
          
          json_array+="]"
          
          # æ ¼å¼åŒ–ä¸º GitHub Actions matrix æ‰€éœ€çš„æ ¼å¼
          matrix_json="{\"include\":${json_array}}"
          
          echo "matrix=$matrix_json" >> $GITHUB_OUTPUT
          echo "Matrix configuration: $matrix_json"

  # å¹¶è¡Œç›‘æ§æ¯ä¸ªä»“åº“
  monitor:
    needs: setup-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.setup-matrix.outputs.matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get current release
        id: current_release
        run: |
          # è·å–å½“å‰ä»“åº“çš„æœ€æ–° Release ä¿¡æ¯
          response=$(curl -s -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ matrix.owner }}/${{ matrix.repo }}/releases/latest")
          
          # æå–ç‰ˆæœ¬å·å’Œ URL
          current_version=$(echo "$response" | jq -r '.name')
          release_url=$(echo "$response" | jq -r '.html_url')
          body=$(echo "$response" | jq -r '.body')
          
          # ä½¿ç”¨ GitHub ç¯å¢ƒæ–‡ä»¶æ ¼å¼è®¾ç½®å˜é‡
          echo "current_version<<EOF" >> $GITHUB_ENV
          echo "$current_version" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          echo "release_url<<EOF" >> $GITHUB_ENV
          echo "$release_url" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          echo "body<<EOF" >> $GITHUB_ENV
          echo "$body" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          # æ‰“å°è°ƒè¯•ä¿¡æ¯
          echo "Current release: $current_version"
          echo "Release url: $release_url"
          echo "Body: $body"

      - name: Compare with previous release
        id: compare
        run: |
          # è¯»å–ä¸Šæ¬¡è®°å½•çš„ç‰ˆæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          previous_version=""
          if [ -f ".github/${{ matrix.owner }}_${{ matrix.repo }}_last_release.txt" ]; then
            previous_version=$(cat ".github/${{ matrix.owner }}_${{ matrix.repo }}_last_release.txt")
          fi
          
          # æ¯”è¾ƒç‰ˆæœ¬
          if [ "$previous_version" != "${{ env.current_version }}" ]; then
            echo "new_release=true" >> $GITHUB_ENV
            echo "previous_version=$previous_version" >> $GITHUB_ENV
          
            # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å­˜å‚¨æ–°ç‰ˆæœ¬ä¿¡æ¯ï¼ˆä½¿ç”¨ jq å®‰å…¨è½¬ä¹‰ JSONï¼‰
            mkdir -p .github/temp_releases
          
            # ä½¿ç”¨ jq æ„å»ºå’Œå†™å…¥ JSONï¼Œç¡®ä¿ç‰¹æ®Šå­—ç¬¦è¢«æ­£ç¡®è½¬ä¹‰
            jq -n --arg owner "${{ matrix.owner }}" \
                  --arg repo "${{ matrix.repo }}" \
                  --arg version "${{ env.current_version }}" \
                  --arg previous "$previous_version" \
                  --arg url "${{ env.release_url }}" \
                  --arg body "${{ env.body }}" \
                  '{owner: $owner, repo: $repo, version: $version, previous: $previous, url: $url, body: $body}' \
                  > ".github/temp_releases/${{ matrix.owner }}_${{ matrix.repo }}.json"
          else
            echo "new_release=false" >> $GITHUB_ENV
          fi
          
          # ä¿å­˜å½“å‰ç‰ˆæœ¬
          mkdir -p .github
          echo "${{ env.current_version }}" > ".github/${{ matrix.owner }}_${{ matrix.repo }}_last_release.txt"

  # æ•´åˆæ‰€æœ‰æ–°ç‰ˆæœ¬å¹¶å‘é€é€šçŸ¥
  notify:
    needs: monitor
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Collect new releases
        id: collect
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬
          if [ -d ".github/temp_releases" ] && [ "$(ls -A .github/temp_releases)" ]; then
            echo "new_releases=true" >> $GITHUB_ENV
          
            # æ„å»ºé€šçŸ¥æ¶ˆæ¯
            message_title="ğŸ‰ å‘ç° ${#.github/temp_releases/*} ä¸ªæ–°ç‰ˆæœ¬æ›´æ–°"
            message_body=""
          
            for file in .github/temp_releases/*.json; do
              # ä» JSON æ–‡ä»¶è¯»å–ä¿¡æ¯
              owner=$(jq -r '.owner' "$file")
              repo=$(jq -r '.repo' "$file")
              version=$(jq -r '.version' "$file")
              previous=$(jq -r '.previous' "$file")
              url=$(jq -r '.url' "$file")
              body=$(jq -r '.body' "$file")
          
              # è¿½åŠ åˆ°æ¶ˆæ¯ä¸»ä½“
              message_body+="\n\n### [${owner}/${repo}](${url})\n\n"
              message_body+="**ç‰ˆæœ¬:** [${version}]\n\n"
          
              if [ "$previous" != "null" ]; then
                message_body+="**ä¸Šä¸€ç‰ˆæœ¬:** [${previous}]\n\n"
              fi
          
              # æˆªå–å‰ 500 å­—ç¬¦çš„æè¿°ï¼ˆé¿å…æ¶ˆæ¯è¿‡é•¿ï¼‰
              if [ ${#body} -gt 500 ]; then
                body="${body:0:500}..."
              fi
          
              message_body+="**æ›´æ–°å†…å®¹:**\n\n${body}\n\n"
            done
          
            # ä¿å­˜æ¶ˆæ¯åˆ°ç¯å¢ƒå˜é‡
            echo "message_title=$message_title" >> $GITHUB_ENV
            echo "message_body<<EOF" >> $GITHUB_ENV
            echo "$message_body" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          
            echo "Found new releases to notify"
          else
            echo "new_releases=false" >> $GITHUB_ENV
            echo "No new releases found"
          fi

      - name: Send DingTalk notification
        if: env.new_releases == 'true'
        run: |
          # è®¾ç½®æ—¶åŒºä¸ºä¸œå…«åŒºå¹¶æ ¼å¼åŒ–æ—¶é—´
          timestamp=$(TZ='Asia/Shanghai' date +"%Y-%m-%d %H:%M:%S%:z")
          
          # æ„å»ºé’‰é’‰æ¶ˆæ¯
          message=$(cat <<EOF
          {
            "msgtype": "markdown",
            "markdown": {
              "title": "$message_title",
              "text": "ğŸš€ **æ£€æµ‹æ—¶é—´: $timestamp**\n\n${{ env.message_body }}"
            },
            "at": {
              "isAtAll": false
            }
          }
          EOF
          )
          
          # å‘é€é€šçŸ¥
          curl -s -X POST "${{ secrets.DINGTALK_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d "$message"
          
          echo "Notification sent for new releases"

      - name: Commit updated release files
        if: env.new_releases == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .github/*_*_last_release.txt
          git commit -m "Update last release versions"
          git push