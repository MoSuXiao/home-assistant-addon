name: Monitor Addon Release

on:
  # schedule:
    # - cron: '0 17 * * *'
  # æ‰‹åŠ¨è§¦å‘ï¼ˆæ–¹ä¾¿æµ‹è¯•ï¼‰
  workflow_dispatch:

jobs:
  # å¹¶è¡Œç›‘æ§æ¯ä¸ªä»“åº“
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check EspHome-Addon release
        uses: ./.github/actions/check-release
        with:
          owner: esphome
          repo: home-assistant-addon

      - name: Check EspHome release
        uses: ./.github/actions/check-release
        with:
          owner: esphome
          repo: esphome

      - name: Collect new releases
        id: collect
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬
          ls -a .github/
          if [ -d ".github/temp_releases" ] && [ "$(ls -A .github/temp_releases)" ]; then
            echo "new_releases=true" >> $GITHUB_OUTPUT
          
            # è·å–æ–‡ä»¶åˆ—è¡¨
            releases=(.github/temp_releases/*)
  
            # è®¡ç®—æ–‡ä»¶æ•°é‡
            release_count=${#releases[@]}
          
            # æ„å»ºé€šçŸ¥æ¶ˆæ¯
            message_title="æ£€æµ‹é€šçŸ¥ï¼šğŸ‰ å‘ç° $release_count ä¸ªæ–°ç‰ˆæœ¬æ›´æ–°"
            message_body="Releaseé€šçŸ¥ï¼š"

            for file in .github/temp_releases/*.json; do
              # ä» JSON æ–‡ä»¶è¯»å–ä¿¡æ¯
              owner=$(jq -r '.owner' "$file")
              repo=$(jq -r '.repo' "$file")
              version=$(jq -r '.version' "$file")
              previous=$(jq -r '.previous' "$file")
              url=$(jq -r '.url' "$file")
              body=$(jq -r '.body' "$file")

              # è¿½åŠ åˆ°æ¶ˆæ¯ä¸»ä½“
              message_body+="\n\n### [${owner}/${repo}](${url})\n\n"
              message_body+="**ç‰ˆæœ¬:** [${version}]\n\n"

              if [ "$previous" != "null" ]; then
                message_body+="**ä¸Šä¸€ç‰ˆæœ¬:** [${previous}]\n\n"
              fi

              # æˆªå–å‰ 500 å­—ç¬¦çš„æè¿°ï¼ˆé¿å…æ¶ˆæ¯è¿‡é•¿ï¼‰
              if [ ${#body} -gt 500 ]; then
                body="${body:0:500}..."
              fi

              message_body+="**æ›´æ–°å†…å®¹:**\n\n${body}\n\n"
            done

            # ä¿å­˜æ¶ˆæ¯åˆ°ç¯å¢ƒå˜é‡
            echo "message_title=$message_title" >> $GITHUB_OUTPUT
            echo "message_body<<EOF" >> $GITHUB_OUTPUT
            echo "$message_body" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            echo "Found new releases to notify"
          else
            echo "new_releases=false" >> $GITHUB_OUTPUT
            echo "No new releases found"
          fi

      - name: Send DingTalk notification
        if: steps.collect.outputs.new_releases == 'true'
        run: |
          # è®¾ç½®æ—¶åŒºä¸ºä¸œå…«åŒºå¹¶æ ¼å¼åŒ–æ—¶é—´
          timestamp=$(TZ='Asia/Shanghai' date +"%Y-%m-%d %H:%M:%S%:z")

          # æ„å»ºé’‰é’‰æ¶ˆæ¯
          message=$(cat <<EOF
          {
            "msgtype": "markdown",
            "markdown": {
              "title": "${{ steps.collect.outputs.message_title }}",
              "text": "ğŸš€ **æ£€æµ‹æ—¶é—´: $timestamp**\n\n${{ steps.collect.outputs.message_body }}"
            },
            "at": {
              "isAtAll": false
            }
          }
          EOF
          )

          # å‘é€é€šçŸ¥
          curl -s -X POST "${{ secrets.DINGTALK_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d "$message"

          echo "Notification sent for new releases"

      - name: Commit updated release files
        if: steps.collect.outputs.new_releases == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .github/*_*_last_release.txt
          git commit -m "Update last release versions"
          git push